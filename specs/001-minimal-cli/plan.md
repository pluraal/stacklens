# Implementation Plan: Minimal CLI

**Branch**: `001-minimal-cli` | **Date**: 2025-07-14 | **Input**: Feature specification  
**Input**: Feature specification from `/specs/001-minimal-cli/spec.md`

## Summary

Implement the `stacklens` CLI entry point and its sole `status` subcommand. The command locates the `.stack` Stackfile in the current working directory, validates it against the Stackfile v0 specification, enumerates all non-gitignored repository files, applies each technology's glob-based detection rules, and reports any uncovered files. The tool exits `0` on full coverage and `1` on any error or coverage gap.

The implementation uses **Commander v14** for command routing, **yaml v2** for YAML parsing, and **globby v16** for gitignore-aware file enumeration. All logic is split into independently testable modules following the project's pure-ESM, TypeScript 5 conventions.

## Technical Context

**Language/Version**: TypeScript 5.x targeting ES2022 output (pure ESM)  
**Primary Dependencies**: Commander v14 (CLI), yaml v2 (YAML parsing), globby v16 (file scanning)  
**Storage**: Filesystem only — reads `.stack` YAML file and enumerates repository files  
**Testing**: Node.js built-in `node:test`; colocated `*.test.ts` files  
**Target Platform**: Node.js ≥ 20.x, all platforms (Linux / macOS / Windows)  
**Project Type**: CLI tool (registered binary via `bin` field in `package.json`)  
**Performance Goals**: Complete `stacklens status` in under 3 seconds for repositories up to 10 000 files (SC-001)  
**Constraints**: Offline-capable; no network I/O; no environment variable dependencies; deterministic output  
**Scale/Scope**: Single binary, ~8 new source files, 3 new runtime dependencies

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design — all items remain passing._

- [x] **Explicitness**: The CLI reads only what is explicitly declared in the Stackfile; no heuristics applied
- [x] **Determinism**: File enumeration + glob matching are deterministic for a given filesystem state; no network, env-var, or ordering dependencies
- [x] **Ontology Model**: Validator enforces single-inheritance, detects cycles, and rejects unknown parents; same-depth conflicts fail with an error
- [x] **Region Granularity**: v0 treats each file as a single region — consistent with spec §3
- [x] **Tags**: Tags are read and preserved in the model but play no role in detection or classification
- [x] **Separation of Concerns**: CLI is strictly read-only; no repository state mutation; does not replace any build tool
- [x] **Backward Compatibility**: `version: "0.1"` is required and validated; unsupported versions are rejected explicitly
- [x] **Minimal Core**: The CLI is a user-facing wrapper over the core classification model; no new core primitives introduced
- [x] **Spec Authority**: `specs/001-minimal-cli/` updated with plan, research, data-model, contracts, and quickstart before any implementation
- [x] **Testing**: `node:test` throughout; colocated `*.test.ts` files; SC-006 (no live filesystem or network) met via injectable dependencies and fixture files

## Project Structure

### Documentation (this feature)

```text
specs/001-minimal-cli/
├── spec.md              # Feature specification (authoritative)
├── plan.md              # This file
├── research.md          # Phase 0: dependency decisions and rationale
├── data-model.md        # Phase 1: TypeScript types and module responsibilities
├── quickstart.md        # Phase 1: dev setup, usage examples, project layout
├── contracts/
│   ├── cli-contract.md      # Command signatures, options, exit codes
│   └── output-format.md     # stdout/stderr format invariants
└── tasks.md             # Phase 2 output (generated by /speckit.tasks — not yet created)
```

### Source Code

```text
src/
├── cli/
│   ├── main.ts                              # #!/usr/bin/env node — imports program + commands, calls parseAsync
│   ├── program.ts                           # Commander Command factory (name, version, description)
│   └── commands/
│       └── status/
│           ├── status-command.ts            # register(program) — adds 'status' subcommand + action handler
│           └── status-command.test.ts       # Integration tests using fixture Stackfiles
│
├── stackfile/
│   ├── types.ts                             # Shared interfaces: StackfileV0, Technology, ValidationResult, …
│   ├── stackfile-loader.ts                  # Locate + read .stack file (I/O only)
│   ├── stackfile-loader.test.ts
│   ├── stackfile-parser.ts                  # Wrap yaml.parse(); return unknown
│   ├── stackfile-parser.test.ts
│   ├── stackfile-validator.ts               # Pure validation: all v0 rules → ValidationResult
│   └── stackfile-validator.test.ts
│
├── coverage/
│   ├── types.ts                             # CoverageResult, RelativeFilePath
│   ├── file-scanner.ts                      # globby + gitignore → string[]
│   ├── file-scanner.test.ts
│   ├── coverage-analyzer.ts                 # Apply detect.include globs → CoverageResult (pure)
│   └── coverage-analyzer.test.ts
│
└── index.ts                                 # Public API re-exports (existing, unchanged)

specs/001-minimal-cli/fixtures/              # Fixture Stackfiles for integration tests
├── valid-all-covered/
│   └── .stack
├── valid-with-uncovered/
│   ├── .stack
│   └── uncovered.xyz
├── invalid-missing-version/
│   └── .stack
├── invalid-unknown-key/
│   └── .stack
├── invalid-cycle/
│   └── .stack
└── empty-technologies/
    └── .stack
```

**Structure Decision**: Single project layout. The `src/cli/` subtree contains the Commander wiring; `src/stackfile/` contains the parsing and validation pipeline; `src/coverage/` contains file enumeration and analysis. Each layer is independently testable. Tests are colocated with source files per the constitution. Fixture files live in `specs/001-minimal-cli/fixtures/` so they are adjacent to the feature spec and excluded from the compiled `dist/` output.

## Architecture Decisions

### AD-1: Register-function pattern for subcommands

Each command module exports `register(program: Command): void`. `main.ts` calls `register(program)` for each command. This satisfies FR-012: adding a future command requires only creating one new module and one new import+call in `main.ts`. No changes to existing command modules or the entry point's structural logic.

### AD-2: Injectable dependencies in the status action handler

The `status` action handler accepts the loader, parser, validator, scanner, and analyzer as parameters (defaulting to the real implementations). This allows unit tests to pass stubs without touching the filesystem, satisfying SC-006.

### AD-3: Separation of I/O from validation from analysis

- `stackfile-loader.ts`: I/O only (read file bytes)
- `stackfile-parser.ts`: YAML parsing only (bytes → unknown)
- `stackfile-validator.ts`: Pure validation (unknown → ValidationResult, no I/O)
- `coverage-analyzer.ts`: Pure analysis (file list + Stackfile → CoverageResult, no I/O)
- `file-scanner.ts`: I/O only (filesystem traversal)

Pure functions are trivially testable and satisfy II. Deterministic Resolution.

### AD-4: `globby` v16 for file scanning

`glob` v11 (existing devDependency) does not natively respect `.gitignore`. `globby` v16 (pure ESM, wraps fast-glob) provides `{ gitignore: true }` that matches Git's actual behaviour. It becomes a runtime dependency. `glob` remains a devDependency for build scripts.

### AD-5: `yaml` v2 for YAML parsing

Returns `unknown` from `parse()`, forcing explicit narrowing in the validator. Aligns with `no any` rule. Pure ESM, native TypeScript types, no `@types/*` needed.

### AD-6: Same-depth conflict detection at analysis time, not validation time

The Stackfile validator performs only structural validation (types, references, cycles). Same-depth conflicts are detectable only at analysis time when files are matched against detection rules. The coverage analyzer detects and surfaces conflicts as errors, causing the status command to exit `1`. This matches stackfile-v0.md §7 (validation) and §6.3 (classification error).

### AD-7: `package.json` updates required

```json
{
  "bin": { "stacklens": "./dist/cli/main.js" },
  "dependencies": {
    "commander": "^14.0.0",
    "yaml": "^2.8.0",
    "globby": "^16.1.0"
  }
}
```

`glob` is moved from the implicit position in devDependencies to remain there (not promoted to a runtime dependency).

## Complexity Tracking

No constitution violations. No complexity justification required.
